hereseasApp.controller("ItemsController",["$stateParams","$scope","requestService",function(e,t,s){function a(){s.GetItemsBySchool(t.selectData,function(e){if(e.result){var s=e.data.items;t.itemsResult=s,i=e.data.totalPage,t.pages=[],t.pages_pre_dot=!1,t.pages_end_dot=!1;for(var a=0;i>a;a++)t.pages[a]={},t.pages[a].id=a+1,a==l-1?(t.pages[a].selected=!0,t.pages[a].show=!0):t.pages[a].selected=!1,l-1>a&&(a>l-4?t.pages[a].show=!0:(t.pages[a].show=!1,t.pages_pre_dot=!0)),a>l-1&&(l+2>a?t.pages[a].show=!0:(t.pages[a].show=!1,t.pages_end_dot=!0));for(var o=[],a=0;a<s.length;a++)o[a]={},o[a].lat=parseFloat(s[a].latitude),o[a].lng=parseFloat(s[a].longitude),o[a].price=s[a].price;cluster_ll={};for(var a=0;a<s.length;a++)void 0!=cluster_ll[o[a].lat+","+o[a].lng]?(cluster_ll[o[a].lat+","+o[a].lng].length++,cluster_ll[o[a].lat+","+o[a].lng].text+="$"+o[a].price+";",3==cluster_ll[o[a].lat+","+o[a].lng].length&&(cluster_ll[o[a].lat+","+o[a].lng].text+="</br>")):(cluster_ll[o[a].lat+","+o[a].lng]={},cluster_ll[o[a].lat+","+o[a].lng].text="",cluster_ll[o[a].lat+","+o[a].lng].text+="$"+o[a].price+"; ",cluster_ll[o[a].lat+","+o[a].lng].ll={},cluster_ll[o[a].lat+","+o[a].lng].length=1,cluster_ll[o[a].lat+","+o[a].lng].ll.lat=o[a].lat,cluster_ll[o[a].lat+","+o[a].lng].ll.lng=o[a].lng);var r=new google.maps.Map(document.getElementById("itemsMap"),{center:cluster_ll[o[0].lat+","+o[0].lng].ll,scrollwheel:!1,zoom:12}),n="ABCDEFGHIJKLMNOPQRSTUVWXYZ",d=0;for(var c in cluster_ll)var u=new google.maps.Marker({map:r,position:cluster_ll[c].ll,label:n[d++%n.length],draggable:!1})}else t.itemsResult=[]})}var l=1,i=1;t.selectData={id:e.schoolId,page:l,pageSize:6,category:"",startPrice:"",endPrice:""},t.schoolId=e.schoolId,a(),t.setCategory=function(e){t.selectData.category=e,t.setPage(0)},t.setPage=function(e){l=e+1,t.selectData.page=l,a()},t.previous=function(){l-1>0&&(l-=1),t.selectData.page=l,a()},t.next=function(){i>=l+1&&(l+=1),t.selectData.page=l,a()},t.changeSearch=function(){a()}}]),hereseasApp.controller("ItemsPostController",["$scope","$location","languageService","userService","alertService","$state","$mdDialog","Upload","fileReader","requestService","$cookies",function(e,t,s,a,l,i,o,r,n,d,c){function u(){var t={steps:[{schoolId:c.schoolId,expireAt:"",itemName:"",category:"",price:"",description:"",cover:"",images:[]},{address:{street:"",apt:"",city:"",state:"",zipcode:"",full:""},longitude:"",latitude:""}]};e.items.push(t),e.ready_upload_img.push(!1)}function g(e){var t=0;return angular.forEach(e,function(){t++}),1==t?!1:!0}function p(t){t&&t.length&&angular.forEach(t,function(t){if(0==t.saved){n.readAsDataUrl(t.file,e).then(function(e){t.url=e});var s=r.upload({url:a.getHost()+"/item/m_upload_image",file:t.file,fileFormDataName:"item"}).progress(function(e){t.prog=parseInt(100*e.loaded/e.total)}).success(function(s,a,l,i){t.saved=!0,t.url="https://s3.amazonaws.com/hereseas-public-images/"+s.data,e.items[t.index].steps[0].images.push(t.url),1==e.items[t.index].steps[0].images.length&&(e.items[t.index].steps[0].cover=t.url),t.cancel=function(){e.items.uploadList.splice(e.items.uploadList.indexOf(t),1),e.items[t.index].steps[0].images.splice(e.items[t.index].steps[0].images.indexOf(t.url),1),0==e.items[t.index].steps[0].images.length&&(e.items[t.index].steps[0].cover="")}}).error(function(e,t,s,a){});t.cancel=function(){s.abort(),e.items.uploadList.splice(e.items.uploadList.indexOf(t),1)}}})}function m(t){e.items.splice(t,1),e.ready_upload_img.splice(t,1)}function f(){e.postedNum=0,angular.forEach(e.items,function(s){s.steps[0].expireAt=e.shared.expireAt,s.steps[1].address=e.shared.address,s.steps[1].longitude=e.shared.longitude,s.steps[1].latitude=e.shared.latitude,d.StartItempost(s.steps[0],function(a){var l=a.data._id;d.ItemStepPost({id:l,step:2},s.steps[1],function(s){d.EndItempost({id:l},function(s){s.result?(e.postedNum=e.postedNum+1,e.postedNum==e.items.length&&(o.hide(),t.path("/items/"+s.data._id))):alert("发布失败")})})})})}function h(){_(e.activePage-1)}function v(){_(e.activePage+1)}function _(t){e.activePage=t}function I(e){return s.getChineseName(e)}var y=new google.maps.Geocoder;e.options1=null,e.details1="",e.addresses=[],e.addressGot=!1,e.addressCorrect=!1,e.validAddress=g,e.mUnits="miles",e.activePage=1,e.lastPage=h,e.nextPage=v,e.setActivePage=_,e.name=I,e.doPost=f,e.add_item=u,e.deleteItem=m,e.canPost=!1,e.tableFilled=[{filled:!1},{filled:!1}],e.shared={expireAt:"",address:{street:"",apt:"",city:"",state:"",zipcode:"",full:""},longitude:"",latitude:""},e.items=[{steps:[{schoolId:c.schoolId,expireAt:"",itemName:"",category:"",price:"",description:"",cover:"",images:[]},{address:{street:"",apt:"",city:"",state:"",zipcode:"",full:""},longitude:"",latitude:""}]}],e.items.files=[],e.items.uploadList=[],e.hide=function(){o.hide()},e.ready_upload_img=[!1],e.add_img=function(){for(var t=0;t<e.ready_upload_img.length;t++)e.ready_upload_img[t]=!0},e.changeFile=function(t){void 0!==e.items.files&&(angular.forEach(e.items.files,function(s){var a=!0;angular.forEach(e.items.uploadList,function(e){angular.equals(e.file,s)&&t==e.index&&(a=!1)}),a&&e.items.uploadList.push({file:s,prog:0,saved:!1,cancel:"",url:"",index:t})}),p(e.items.uploadList))},e.$watch(function(){return{v1:e.shared,v2:e.items}},function(t){angular.forEach(e.items,function(t){""==e.shared.expireAt||""==t.steps[0].itemName||""==t.steps[0].category||""==t.steps[0].price||0==t.steps[0].images.length?e.tableFilled[0].filled=!1:e.tableFilled[0].filled=!0}),""==t.v1.address.zipcode||void 0==t.v1.address.zipcode?e.tableFilled[1].filled=!1:e.tableFilled[1].filled=!0,void 0!=t.v1.address.zipcode?e.addressCorrect=!0:e.addressCorrect=!1,e.tableFilled[0].filled||e.tableFilled[1].filled?e.tableFilled[0].filled&&e.tableFilled[1].filled?e.sn=0:e.sn=1:e.sn=2,0==e.sn?e.canPost=!0:e.canPost=!1},!0),e.$watch("details1",function(t){if(t&&e.validAddress(t)){e.addressGot=!0,e.addresses=[];for(var s={street_number:"short_name",route:"long_name",locality:"long_name",administrative_area_level_1:"short_name",postal_code:"short_name"},a=0;a<e.details1.address_components.length;a++){var l=e.details1.address_components[a].types[0];if(s[l]){var i=e.details1.address_components[a][s[l]];e.addresses.push(i)}}e.shared.address.street=e.addresses[0]+" "+e.addresses[1],e.shared.address.city=e.addresses[2],e.shared.address.state=e.addresses[3],e.shared.address.zipcode=e.addresses[4],y.geocode({address:e.shared.address.full},function(t,s){s==google.maps.GeocoderStatus.OK&&(e.shared.latitude=t[0].geometry.location.lat(),e.shared.longitude=t[0].geometry.location.lng())})}})}]),hereseasApp.controller("ItemsDisplayController",["$state","$scope","$stateParams","languageService","requestService","$mdDialog","userService","alertService","$cookies",function(e,t,s,a,l,i,o,r,n){function d(){o.deleteFavorite({id:s.itemId,category:"items"}).then(function(e){e.result&&(t.isFav=!1)})}function c(){"true"==n.login?o.postFavorite({id:s.itemId,category:"items"}).then(function(e){e.result&&(t.isFav=!0)}):r.alert("请登录").then(function(){t.$broadcast("login","1")})}function u(e){"true"==n.login?i.show({controller:["$scope","recvId",function(e,t){e.content="",e.sendmessage=function(){o.sendmessage({id:t,content:e.content}).then(function(e){e.result?alert("Message has been sent"):alert("err")})}}],templateUrl:"/app/view/message.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,locals:{recvId:t.item.userId}}):r.alert("请登录").then(function(){t.$broadcast("login","1")})}function g(){l.GetItem({id:s.itemId},function(s){if(s.result){t.item=s.data[0];var a={},i=t.item;l.GetSchool({id:i.schoolId},function(e){e.result&&(t.schoolName=e.data.name)}),l.GetOtherItems({id:i.userId,itemId:i._id},function(e){e.result&&(t.otherItems=e.data,t.otherItems.length>9&&(t.hasMore=!0))}),a.lat=parseFloat(i.latitude),a.lng=parseFloat(i.longitude);var o=new google.maps.Map(document.getElementById("itemMap"),{center:a,scrollwheel:!0,zoom:12,scrollwheel:!1});({url:"/app/view/img/apts/marker.png",size:new google.maps.Size(58,24),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(36,24)}),new google.maps.Marker({map:o,position:a,label:"A",draggable:!1})}else e.go("home")})}t.addFav=c,t.delFav=d,t.sendMessage=u,t.hasMore=!1,"true"==n.login&&l.GetFavList(function(e){null!==e.data.items?t.favoriteItems=e.data.items:t.favoriteItems=[],t.isFav=-1!==t.favoriteItems.indexOf(s.itemId)}),t.goToEach=function(s){switch(t.otherItems[s].identity){case 1:e.go("rooms",{aptId:t.otherItems[s].content._id});break;case 2:e.go("cars",{carId:t.otherItems[s].content._id});break;case 3:e.go("items",{itemId:t.otherItems[s].content._id})}},g(),t.showOtherUserInfo=function(s){e.go("othersProfile",{schoolId:t.item.schoolId,othersId:s})}}]);