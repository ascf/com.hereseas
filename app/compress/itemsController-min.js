hereseasApp.controller("ItemsController",function($stateParams,$scope,requestService,userService){var cur_page=1;var max_page=1;$scope.selectData={id:$stateParams.schoolId,page:cur_page,pageSize:6,category:"",startPrice:"",endPrice:""};$scope.schoolId=$stateParams.schoolId;function updatePage(){requestService.GetItemsBySchool($scope.selectData,function(res){if(res.result){var items=res.data.items;$scope.itemsResult=items;max_page=res.data.totalPage;$scope.pages=[];$scope.pages_pre_dot=false;$scope.pages_end_dot=false;for(var i=0;i<max_page;i++){$scope.pages[i]={};$scope.pages[i].id=i+1;if(i==cur_page-1){$scope.pages[i].selected=true;$scope.pages[i].show=true}else{$scope.pages[i].selected=false}if(i<cur_page-1){if(i>cur_page-4){$scope.pages[i].show=true}else{$scope.pages[i].show=false;$scope.pages_pre_dot=true}}if(i>cur_page-1){if(i<cur_page+2){$scope.pages[i].show=true}else{$scope.pages[i].show=false;$scope.pages_end_dot=true}}}var myLatLng=[];for(var i=0;i<items.length;i++){myLatLng[i]={};myLatLng[i].lat=parseFloat(items[i].latitude);myLatLng[i].lng=parseFloat(items[i].longitude);myLatLng[i].price=items[i].price}cluster_ll={};for(var i=0;i<items.length;i++){if(cluster_ll[myLatLng[i].lat+","+myLatLng[i].lng]!=undefined){cluster_ll[myLatLng[i].lat+","+myLatLng[i].lng].length++;cluster_ll[myLatLng[i].lat+","+myLatLng[i].lng].text+="$"+myLatLng[i].price+";";if(cluster_ll[myLatLng[i].lat+","+myLatLng[i].lng].length==3){cluster_ll[myLatLng[i].lat+","+myLatLng[i].lng].text+="</br>"}}else{cluster_ll[myLatLng[i].lat+","+myLatLng[i].lng]={};cluster_ll[myLatLng[i].lat+","+myLatLng[i].lng].text="";cluster_ll[myLatLng[i].lat+","+myLatLng[i].lng].text+="$"+myLatLng[i].price+"; ";cluster_ll[myLatLng[i].lat+","+myLatLng[i].lng].ll={};cluster_ll[myLatLng[i].lat+","+myLatLng[i].lng].length=1;cluster_ll[myLatLng[i].lat+","+myLatLng[i].lng].ll.lat=myLatLng[i].lat;cluster_ll[myLatLng[i].lat+","+myLatLng[i].lng].ll.lng=myLatLng[i].lng}}var map=new google.maps.Map(document.getElementById("itemsMap"),{center:cluster_ll[myLatLng[0].lat+","+myLatLng[0].lng].ll,scrollwheel:false,zoom:12});var labels="ABCDEFGHIJKLMNOPQRSTUVWXYZ";var labelIndex=0;for(var cll in cluster_ll){var marker=new google.maps.Marker({map:map,position:cluster_ll[cll].ll,label:labels[labelIndex++%labels.length],draggable:false})}}else{$scope.itemsResult=[]}})}updatePage();$scope.setCategory=function(category){$scope.selectData.category=category;$scope.setPage(0)};$scope.setPage=function(pg){cur_page=pg+1;$scope.selectData.page=cur_page;updatePage()};$scope.previous=function(){if(cur_page-1>0){cur_page=cur_page-1}$scope.selectData.page=cur_page;updatePage()};$scope.next=function(){if(cur_page+1<=max_page){cur_page=cur_page+1}$scope.selectData.page=cur_page;updatePage()};$scope.changeSearch=function(){updatePage()}});hereseasApp.controller("ItemsPostController",function($scope,$location,languageService,userService,alertService,$state,$mdDialog,Upload,fileReader,requestService,$filter,$cookies,dateService){var geocoder=new google.maps.Geocoder();$scope.options1=null;$scope.details1="";$scope.addresses=[];$scope.addressGot=false;$scope.addressCorrect=false;$scope.validAddress=validAddress;$scope.mUnits="miles";$scope.activePage=1;$scope.lastPage=lastPage;$scope.nextPage=nextPage;$scope.setActivePage=setActivePage;$scope.name=name;$scope.doPost=doPost;$scope.add_item=add_item;$scope.deleteItem=deleteItem;$scope.canPost=false;$scope.tableFilled=[{filled:false},{filled:false}];$scope.shared={expireAt:"",address:{street:"",apt:"",city:"",state:"",zipcode:"",full:""},longitude:"",latitude:""};$scope.items=[{steps:[{schoolId:$cookies["schoolId"],expireAt:"",itemName:"",category:"",price:"",description:"",cover:"",images:[]},{address:{street:"",apt:"",city:"",state:"",zipcode:"",full:""},longitude:"",latitude:""}]}];$scope.items.files=[];$scope.items.uploadList=[];$scope.hide=function(){$mdDialog.hide()};function add_item(){var val={steps:[{schoolId:$cookies["schoolId"],expireAt:"",itemName:"",category:"",price:"",description:"",cover:"",images:[]},{address:{street:"",apt:"",city:"",state:"",zipcode:"",full:""},longitude:"",latitude:""}]};$scope.items.push(val);$scope.ready_upload_img.push(false)}$scope.ready_upload_img=[false];$scope.add_img=function(){for(var i=0;i<$scope.ready_upload_img.length;i++){$scope.ready_upload_img[i]=true}};function validAddress(value){var num=0;angular.forEach(value,function(){num++});return num==1?false:true}$scope.changeFile=function(index){if($scope.items.files!==undefined){angular.forEach($scope.items.files,function(file){var flag=true;angular.forEach($scope.items.uploadList,function(upload){if(angular.equals(upload.file,file)&&index==upload.index){flag=false}});if(flag){$scope.items.uploadList.push({file:file,prog:0,saved:false,cancel:"",url:"",index:index})}});upload($scope.items.uploadList)}};function upload(files){if(files&&files.length){angular.forEach(files,function(key){if(key.saved==false){fileReader.readAsDataUrl(key.file,$scope).then(function(result){key.url=result});var up=Upload.upload({url:userService.getHost()+"/item/m_upload_image",file:key.file,fileFormDataName:"item"}).progress(function(evt){key.prog=parseInt(100*evt.loaded/evt.total)}).success(function(data,status,headers,config){key.saved=true;key.url="https://s3.amazonaws.com/hereseas-public-images/"+data.data;$scope.items[key.index].steps[0].images.push(key.url);if($scope.items[key.index].steps[0].images.length==1){$scope.items[key.index].steps[0].cover=key.url}key.cancel=function(){$scope.items.uploadList.splice($scope.items.uploadList.indexOf(key),1);$scope.items[key.index].steps[0].images.splice($scope.items[key.index].steps[0].images.indexOf(key.url),1);if($scope.items[key.index].steps[0].images.length==0){$scope.items[key.index].steps[0].cover=""}}}).error(function(data,status,headers,config){});key.cancel=function(){up.abort();$scope.items.uploadList.splice($scope.items.uploadList.indexOf(key),1)}}})}}function deleteItem(index){$scope.items.splice(index,1);$scope.ready_upload_img.splice(index,1)}function doPost(){$scope.postedNum=0;angular.forEach($scope.items,function(item){item.steps[0].expireAt=$scope.shared.expireAt;item.steps[1].address=$scope.shared.address;item.steps[1].longitude=$scope.shared.longitude;item.steps[1].latitude=$scope.shared.latitude;requestService.StartItempost(item.steps[0],function(res){var draftId=res.data._id;requestService.ItemStepPost({id:draftId,step:2},item.steps[1],function(res){requestService.EndItempost({id:draftId},function(res){if(res.result){$scope.postedNum=$scope.postedNum+1;if($scope.postedNum==$scope.items.length){$mdDialog.hide();$location.path("/items/"+res.data._id)}}else{alert("发布失败")}})})})})}function lastPage(){setActivePage($scope.activePage-1)}function nextPage(){setActivePage($scope.activePage+1)}function setActivePage(page){$scope.activePage=page}function name(name){return languageService.getChineseName(name)}$scope.$watch(function(){return{v1:$scope.shared,v2:$scope.items}},function(newValue){angular.forEach($scope.items,function(item){if($scope.shared.expireAt==""||item.steps[0].itemName==""||item.steps[0].category==""||item.steps[0].price==""||item.steps[0].images.length==0){$scope.tableFilled[0].filled=false}else{$scope.tableFilled[0].filled=true}});if(newValue.v1.address.zipcode==""||newValue.v1.address.zipcode==undefined){$scope.tableFilled[1].filled=false}else{$scope.tableFilled[1].filled=true}if(newValue.v1.address.zipcode!=undefined){$scope.addressCorrect=true}else{$scope.addressCorrect=false}if(!$scope.tableFilled[0].filled&&!$scope.tableFilled[1].filled){$scope.sn=2}else{if($scope.tableFilled[0].filled&&$scope.tableFilled[1].filled){$scope.sn=0}else{$scope.sn=1}}if($scope.sn==0){$scope.canPost=true}else{$scope.canPost=false}},true);$scope.$watch("details1",function(newValue){if(newValue&&$scope.validAddress(newValue)){$scope.addressGot=true;$scope.addresses=[];var componentForm={street_number:"short_name",route:"long_name",locality:"long_name",administrative_area_level_1:"short_name",postal_code:"short_name"};for(var i=0;i<$scope.details1.address_components.length;i++){var addressType=$scope.details1.address_components[i].types[0];if(componentForm[addressType]){var val=$scope.details1.address_components[i][componentForm[addressType]];$scope.addresses.push(val)}}$scope.shared.address.street=$scope.addresses[0]+" "+$scope.addresses[1];$scope.shared.address.city=$scope.addresses[2];$scope.shared.address.state=$scope.addresses[3];$scope.shared.address.zipcode=$scope.addresses[4];geocoder.geocode({"address":$scope.shared.address.full},function(results,status){if(status==google.maps.GeocoderStatus.OK){$scope.shared.latitude=results[0].geometry.location.lat();$scope.shared.longitude=results[0].geometry.location.lng()}else{}})}})});hereseasApp.controller("ItemsDisplayController",function($state,$scope,roomService,$stateParams,languageService,requestService,$mdDialog,userService,alertService,$cookies){$scope.addFav=addFav;$scope.delFav=delFav;$scope.sendMessage=sendMessage;$scope.hasMore=false;if($cookies.login=="true"){requestService.GetFavList(function(res){if(res.data.items!==null){$scope.favoriteItems=res.data.items}else{$scope.favoriteItems=[]}$scope.isFav=$scope.favoriteItems.indexOf($stateParams.itemId)!==-1})}function delFav(){userService.deleteFavorite({id:$stateParams.itemId,category:"items"}).then(function(res){if(res.result){$scope.isFav=false}else{}})}function addFav(){if($cookies.login=="true"){userService.postFavorite({id:$stateParams.itemId,category:"items"}).then(function(res){if(res.result){$scope.isFav=true}else{}})}else{alertService.alert("请登录").then(function(){$scope.$broadcast("login","1")})}}function sendMessage(ev){if($cookies.login=="true"){$mdDialog.show({controller:["$scope","recvId",function($scope,recvId){$scope.content="";$scope.sendmessage=function(){userService.sendmessage({id:recvId,content:$scope.content}).then(function(res){if(res.result){alert("Message has been sent")}else{alert("err")}})}}],templateUrl:"/app/view/message.html",parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:true,locals:{recvId:$scope.item.userId}})}else{alertService.alert("请登录").then(function(){$scope.$broadcast("login","1")})}}$scope.goToEach=function(index){switch($scope.otherItems[index].identity){case 1:$state.go("rooms",{aptId:$scope.otherItems[index].content._id});break;case 2:$state.go("cars",{carId:$scope.otherItems[index].content._id});break;case 3:$state.go("items",{itemId:$scope.otherItems[index].content._id});break}};function itemSetMap(){requestService.GetItem({id:$stateParams.itemId},function(res){if(res.result){$scope.item=res.data[0];var myLatLng={};var item=$scope.item;requestService.GetSchool({id:item.schoolId},function(res){if(res.result){$scope.schoolName=res.data.name}else{}});requestService.GetOtherItems({id:item.userId,itemId:item._id},function(res){if(res.result){$scope.otherItems=res.data;if($scope.otherItems.length>9){$scope.hasMore=true}}else{}});myLatLng.lat=parseFloat(item.latitude);myLatLng.lng=parseFloat(item.longitude);var map=new google.maps.Map(document.getElementById("itemMap"),{center:myLatLng,scrollwheel:true,zoom:12,scrollwheel:false});var image={url:"/app/view/img/apts/marker.png",size:new google.maps.Size(58,24),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(36,24)};var shape={coords:[0,0,0,24,58,24,58,0],type:"poly"};var marker=new google.maps.Marker({map:map,position:myLatLng,label:"A",draggable:false})}else{$state.go("home")}})}itemSetMap();$scope.showOtherUserInfo=function(othersId){$state.go("othersProfile",{schoolId:$scope.item.schoolId,othersId:othersId})}});