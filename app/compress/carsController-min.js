hereseasApp.controller("AllCarsController",["$scope","$stateParams","requestService","userService",function(e,t,a,s){function r(){a.GetCarsBySchool(e.selectData,function(t){if(t.result){var a=t.data.cars;e.carsResult=a,i=t.data.totalPage,e.pages=[],e.pages_pre_dot=!1,e.pages_end_dot=!1;for(var s=0;i>s;s++)e.pages[s]={},e.pages[s].id=s+1,s==l-1?(e.pages[s].selected=!0,e.pages[s].show=!0):e.pages[s].selected=!1,l-1>s&&(s>l-4?e.pages[s].show=!0:(e.pages[s].show=!1,e.pages_pre_dot=!0)),s>l-1&&(l+2>s?e.pages[s].show=!0:(e.pages[s].show=!1,e.pages_end_dot=!0));for(var r=[],s=0;s<a.length;s++)r[s]={},r[s].lat=parseFloat(a[s].latitude),r[s].lng=parseFloat(a[s].longitude),r[s].price=a[s].price;cluster_ll={};for(var s=0;s<a.length;s++)void 0!=cluster_ll[r[s].lat+","+r[s].lng]?(cluster_ll[r[s].lat+","+r[s].lng].length++,cluster_ll[r[s].lat+","+r[s].lng].text+="$"+r[s].price+"; ",3==cluster_ll[r[s].lat+","+r[s].lng].length&&(cluster_ll[r[s].lat+","+r[s].lng].text+="</br>")):(cluster_ll[r[s].lat+","+r[s].lng]={},cluster_ll[r[s].lat+","+r[s].lng].text="",cluster_ll[r[s].lat+","+r[s].lng].text+="$"+r[s].price+"; ",cluster_ll[r[s].lat+","+r[s].lng].ll={},cluster_ll[r[s].lat+","+r[s].lng].ll.lat=r[s].lat,cluster_ll[r[s].lat+","+r[s].lng].ll.lng=r[s].lng,cluster_ll[r[s].lat+","+r[s].lng].length=1);var o=new google.maps.Map(document.getElementById("carsMap"),{center:cluster_ll[r[0].lat+","+r[0].lng].ll,scrollwheel:!1,zoom:12}),d="ABCDEFGHIJKLMNOPQRSTUVWXYZ",n=0;for(var c in cluster_ll)var p=new google.maps.Marker({map:o,position:cluster_ll[c].ll,label:d[n++%d.length],draggable:!1})}else e.carsResult=[]})}var l=1,i=1;e.min_price=0,e.max_price=4e4,$("#price-slider").on("slideStop",function(t){e.selectData.startPrice=t.value[0],e.selectData.endPrice=t.value[1],r()}),e.selectData={id:t.schoolId,page:l,pageSize:6,startPrice:"",endPrice:"",category:""},e.schoolId=t.schoolId,r(),e.setStyle=function(t){e.selectData.category=t,e.setPage(0)},e.setPage=function(t){l=t+1,e.selectData.page=l,r()},e.previous=function(){l-1>0&&(l-=1),e.selectData.page=l,r()},e.next=function(){i>=l+1&&(l+=1),e.selectData.page=l,r()},e.changeSearch=function(){r()}}]),hereseasApp.controller("CarDisplayController",["$state","$scope","$stateParams","languageService","requestService","$mdDialog","userService","alertService","$cookies",function(e,t,a,s,r,l,i,o,d){r.GetCar({id:a.carId},function(n){function c(){i.deleteFavorite({id:a.carId,category:"cars"}).then(function(e){e.result&&(t.isFav=!1)})}function p(){"true"==d.login?i.postFavorite({id:a.carId,category:"cars"}).then(function(e){e.result&&(t.isFav=!0)}):o.alert("请登录").then(function(){t.$broadcast("login","1")})}function g(e){return s.getChineseName(e)}if(n.result){t.data=n.data[0],t.addFav=p,t.delFav=c;var u=t.data;myLatLng={},myLatLng.lat=parseFloat(u.latitude),myLatLng.lng=parseFloat(u.longitude);var f=new google.maps.Map(document.getElementById("carMap"),{center:myLatLng,scrollwheel:!0,zoom:12,scrollwheel:!1});({url:"/app/view/img/apts/marker.png",size:new google.maps.Size(58,24),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(36,24)}),new google.maps.Marker({map:f,position:myLatLng,label:"A",draggable:!1}),t.images=[];for(var m=0;m<t.data.images.length;m++)t.images.push({thumb:t.data.images[m],img:t.data.images[m]});"true"==d.login&&r.GetFavList(function(e){null!==e.data.cars?t.favoriteCars=e.data.cars:t.favoriteCars=[],t.isFav=-1!==t.favoriteCars.indexOf(a.carId)}),t.showImgs=function(e,t,a){l.show({controller:function(e){e.images=t,e.index=a},templateUrl:"/app/view/partials/_image-display.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0})},r.GetUser({id:t.data.userId},function(e){t.seller=e.data}),r.GetSchool({id:t.data.schoolId},function(e){e.result&&(t.schoolName=e.data.name)}),t.showOtherUserInfo=function(a){e.go("othersProfile",{schoolId:t.data.schoolId,othersId:a})},t.name=g}else o.alert("该发布不存在或已被移除").then(function(){e.go("home")})})}]),hereseasApp.controller("CarPostController",["$scope","$location","languageService","userService","$mdDialog","Upload","fileReader","requestService","$cookies",function(e,t,a,s,r,l,i,o,d){function n(e){var t=0;return angular.forEach(e,function(){t++}),1==t?!1:!0}function c(){"update"==s.getCarDraft().state?(r.hide(),t.path("/cars/"+s.getDraft().id)):("edit"==s.getCarDraft().state||"post"==s.getCarDraft().state)&&o.EndCarpost({id:s.getCarDraft().id},function(e){var a=s.getCarDraft().id;s.setCarDraft({}),r.hide(),t.path("/cars/"+a)})}function p(){e.activePage=e.activePage-1}function g(){e.activePage=e.activePage+1}function u(t){e.activePage=t}function f(e){return a.getChineseName(e)}var m=new google.maps.Geocoder;e.options1=null,e.details1="",e.addresses=[],e.addressGot=!1,e.addressCorrect=!1,e.validAddress=n,e.mUnits="miles",e.activePage=1,e.lastPage=p,e.nextPage=g,e.setActivePage=u,e.name=f,e.doPost=c,e.canPost=!1,e.arrUploads=[],e.tableFilled=[{filled:!1},{filled:!1},{filled:!0},{filled:!1},{filled:!1},{filled:!1}],e.hide=function(){s.setCarDraft({}),r.hide()},e.$watch("details1",function(t){if(t&&e.validAddress(t)){e.addressGot=!0,e.addresses=[];for(var a={street_number:"short_name",route:"long_name",locality:"long_name",administrative_area_level_1:"short_name",postal_code:"short_name"},s=0;s<e.details1.address_components.length;s++){var r=e.details1.address_components[s].types[0];if(a[r]){var l=e.details1.address_components[s][a[r]];e.addresses.push(l)}}e.steps[4].address.street=e.addresses[0]+" "+e.addresses[1],e.steps[4].address.city=e.addresses[2],e.steps[4].address.state=e.addresses[3],e.steps[4].address.zipcode=e.addresses[4],m.geocode({address:e.steps[4].address.full},function(t,a){a==google.maps.GeocoderStatus.OK&&(e.steps[4].latitude=t[0].geometry.location.lat(),e.steps[4].longitude=t[0].geometry.location.lng())})}}),e.removeImage=function(t){"update"==s.getCarDraft().state?o.GetCar({id:s.getCarDraft().id},function(a){e.steps[5].images=a.data[0].images;var r=e.steps[5].images.indexOf(t);e.steps[5].images.splice(r,1),0==e.steps[5].images.length?e.steps[5].cover="":e.steps[5].cover=e.steps[5].images[0],o.CarStepPost({id:s.getCarDraft().id,step:6},e.steps[5],function(t){o.GetCar({id:s.getCarDraft().id},function(t){e.steps[5].images=t.data[0].images,e.steps[5].cover=t.data[0].cover})})}):o.GetCarDraft({id:s.getCarDraft().id},function(a){e.steps[5].images=a.data[0].images;var r=e.steps[5].images.indexOf(t);e.steps[5].images.splice(r,1),0==e.steps[5].images.length?e.steps[5].cover="":e.steps[5].cover=e.steps[5].images[0],o.CarStepPost({id:s.getCarDraft().id,step:6},e.steps[5],function(t){o.GetCarDraft({id:s.getCarDraft().id},function(t){e.steps[5].images=t.data[0].images,e.steps[5].cover=t.data[0].cover})})})},e.$watch("files",function(t,a){angular.equals(t,a)||t===[]||e.upload(e.files)}),e.upload=function(t){if(t&&t.length&&t.length<11-e.arrUploads.length){for(var a=e.arrUploads.length;a<t.length;a++)e.arrUploads.push({file:t[a],prog:0,content:"default.png",saved:!1,cancel:"",id:""});angular.forEach(e.arrUploads,function(t){if(0==t.saved){i.readAsDataUrl(t.file,e).then(function(e){t.content=e});var a=l.upload({url:s.getHost()+"/car/m_upload_image",file:t.file,fileFormDataName:"car"}).progress(function(e){t.prog=parseInt(100*e.loaded/e.total)}).success(function(a,r,l,i){t.saved=!0,t.id="https://s3.amazonaws.com/hereseas-public-images/"+a.data,e.steps[5].images.push(t.id),1==e.steps[5].images.length&&(e.steps[5].cover=e.steps[5].images[0]),e.arrUploads.splice(e.arrUploads.indexOf(t),1),e.files.splice(e.files.indexOf(t.file),1),o.CarStepPost({id:s.getCarDraft().id,step:6},e.steps[5],function(e){})}).error(function(e,t,a,s){alert("上传失败"+e)});t.cancel=function(){a.abort(),e.arrUploads.splice(e.arrUploads.indexOf(t),1),e.files.splice(e.files.indexOf(t.file),1)}}})}},e.steps=[{year:"",make:"",totalMiles:"",category:"轿车",model:"",style:"",price:"",boughtDate:void 0,schoolId:d.schoolId},{color:"",noAccident:!1,driveSystem:"",transSystem:"",output:""},{breakType:{ABS:!1,ESC:!1},security:{double_airbag:!1,side_airbag:!1,curtain:!1},comfort:{elec_lock:!1,elec_start:!1,cruise:!1,elec_window:!1,navi:!1,backup_supp:!1,CD:!1,DVD:!1,bluetooth:!1,USB:!1,sun_roof:!1}},{title:"",description:""},{address:{street:"",apt:"",city:"",state:"",zipcode:"",full:""},latitude:"",longitude:""},{cover:"",images:[]}],e.setEditModel=function(t){void 0!==t.year&&(e.steps[0].year=t.year),void 0!==t.make&&(e.steps[0].make=t.make),void 0!==t.totalMiles&&(e.steps[0].totalMiles=t.totalMiles),void 0!==t.category&&(e.steps[0].category=t.category),void 0!==t.model&&(e.steps[0].model=t.model),void 0!==t.style&&(e.steps[0].style=t.style),void 0!==t.price&&(e.steps[0].price=t.price),void 0!==t.boughtDate&&(e.steps[0].boughtDate=t.boughtDate),void 0!==t.color&&(e.steps[1].color=t.color),void 0!==t.driveSystem&&(e.steps[1].driveSystem=t.driveSystem),void 0!==t.noAccident&&(e.steps[1].noAccident=t.noAccident),void 0!==t.output&&(e.steps[1].output=t.output),void 0!==t.transSystem&&(e.steps[1].transSystem=t.transSystem),void 0!==t.breakType&&(e.steps[2].breakType=t.breakType),void 0!==t.comfort&&(e.steps[2].comfort=t.comfort),void 0!==t.security&&(e.steps[2].security=t.security),void 0!==t.description&&(e.steps[3].description=t.description),void 0!==t.title&&(e.steps[3].title=t.title),void 0!==t.address&&(e.steps[4].address=t.address,e.addressGot=!0,e.addresses[0]=e.steps[4].address.street.split(" ")[0],e.addresses[1]=e.steps[4].address.street.split(" ")[1],e.addresses[2]=e.steps[4].address.city,e.addresses[3]=e.steps[4].address.state,e.addresses[4]=e.steps[4].address.zipcode),void 0!==t.cover&&(e.steps[5].cover=t.cover,e.steps[5].images=t.images)},""!==s.getCarDraft().id&&("edit"==s.getCarDraft().state?o.GetCarDraft({id:s.getCarDraft().id},function(t){e.setEditModel(t.data[0])}):"update"==s.getCarDraft().state&&o.GetCar({id:s.getCarDraft().id},function(t){e.setEditModel(t.data[0])})),e.$watch(function(){return e.steps[0]},function(t){""==t.year||""==t.make||""==t.totalMiles||""==t.category||""==t.model||""==t.price||void 0==t.boughtDate?e.tableFilled[0].filled=!1:(e.tableFilled[0].filled=!0,angular.equals(s.getCarDraft().id,"")?o.StartCarpost(e.steps[0],function(t){s.setCarDraft({id:t.data._id,state:"post"}),o.CarStepPost({id:s.getCarDraft().id,step:3},e.steps[2],function(e){})}):o.CarStepPost({id:s.getCarDraft().id,step:1},e.steps[0],function(e){}))},!0),e.$watch(function(){return e.steps[1]},function(t){""==t.color||""==t.driveSystem||""==t.transSystem||""==t.output?e.tableFilled[1].filled=!1:(e.tableFilled[1].filled=!0,o.CarStepPost({id:s.getCarDraft().id,step:2},e.steps[1],function(e){}))},!0),e.$watch(function(){return e.steps[2]},function(t){""!==s.getCarDraft().id&&o.CarStepPost({id:s.getCarDraft().id,step:3},e.steps[2],function(e){})},!0),e.$watch(function(){return e.steps[3]},function(t){""!=t.title&&""!=t.description?(e.tableFilled[3].filled=!0,o.CarStepPost({id:s.getCarDraft().id,step:4},e.steps[3],function(e){})):e.tableFilled[3].filled=!1},!0),e.$watch(function(){return e.steps[4]},function(t){""!=t.address.zipcode&&void 0!=t.address.zipcode?(e.tableFilled[4].filled=!0,o.CarStepPost({id:s.getCarDraft().id,step:5},e.steps[4],function(e){})):e.tableFilled[4].filled=!1,void 0!=t.address.zipcode?e.addressCorrect=!0:e.addressCorrect=!1},!0),e.$watch(function(){return e.steps[5]},function(t){""!==t.cover?e.tableFilled[5].filled=!0:e.tableFilled[5].filled=!1},!0),e.sn=0,e.$watch(function(){return e.tableFilled},function(t){e.sn=0;for(var a=0;6>a;a++)t[a].filled||(e.sn=e.sn+1);0==e.sn?e.canPost=!0:e.canPost=!1},!0)}]);