hereseasApp.controller("HeaderController",["$scope","userService","$mdDialog","alertService","requestService","$state","$cookies",function(t,e,n,o,a,s,c){function i(){return"true"==c.login}function r(){a.LogOut(function(){c.login=!1,delete c.schoolId,delete c.userId,t.$emit("logout","1"),s.reload()})}function l(){s.go("home")}function u(){s.go("profile")}function d(t,o,a){1==a?e.setCarDraft({id:o,state:"update"}):e.setCarDraft({id:o,state:"edit"}),n.show({templateUrl:"/app/view/car_post.html",parent:angular.element(document.body),targetEvent:t,clickOutsideToClose:!1})}function g(t,o,a){1==a?e.setDraft({id:o,state:"update"}):e.setDraft({id:o,state:"edit"}),n.show({templateUrl:"/app/view/room_post.html",parent:angular.element(document.body),targetEvent:t,clickOutsideToClose:!1})}function p(a){i()?void 0==c.schoolId?o.alert("请先填写你的学校").then(function(){s.go("profile")}):(e.setDraft({id:"",state:"post"}),n.show({templateUrl:"/app/view/room_post.html",parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!1})):o.alert("请先登录").then(function(){t.showLogin()})}function f(a){i()?void 0==c.schoolId?o.alert("请先填写你的学校").then(function(){s.go("profile")}):(e.setCarDraft({id:"",state:"post"}),n.show({templateUrl:"/app/view/car_post.html",parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!1})):o.alert("请先登录").then(function(){t.showLogin()})}function h(e){i()?void 0==c.schoolId?o.alert("请先填写你的学校").then(function(){s.go("profile")}):n.show({templateUrl:"/app/view/items_post.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!1}):o.alert("请先登录").then(function(){t.showLogin()})}function m(a){i()?void 0==c.schoolId?o.alert("请先填写你的学校").then(function(){s.go("profile")}):(e.setDraft({}),n.show({templateUrl:"/app/view/activ_post_temp.html",parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!1})):o.alert("请先登录").then(function(){t.showLogin()})}function w(t){e.setSignupOrLogin("signup"),n.show({templateUrl:"/app/view/signup_login.html",parent:angular.element(document.body),targetEvent:t,clickOutsideToClose:!0})}function v(t){e.setSignupOrLogin("login"),n.show({templateUrl:"/app/view/signup_login.html",parent:angular.element(document.body),targetEvent:t,clickOutsideToClose:!0})}function C(){setTimeout(function(){t.$apply(function(){1==e.getLoginState()&&a.GetUserSelf(function(e){e.result?C():o.alert("Session time out, please login again!").then(function(){a.LogOut(function(){c.login=!1,delete c.userId,delete c.schoolId,t.$emit("logout","1")})})})})},9e5)}t.logged=i,t.logOut=r,t.goHome=l,t.goProfile=u,t.editCarPost=d,t.editAptPost=g,t.showRoompost=p,t.showCarpost=f,t.showItemspost=h,t.showActivspost=m,t.showSignup=w,t.showLogin=v,t.$on("login",function(){t.showLogin()}),t.$watch(function(){return c.newmsg},function(e){0==e||void 0==e?t.newMsg=!1:t.newMsg=!0}),a.GetUserSelf(function(e){e.result&&(c.login=!0,t.username=e.data.username,c.userId=e.data.id,void 0!==e.data.schoolId&&(c.schoolId=e.data.schoolId),c.newmsg=0,a.GetContact(function(t){angular.forEach(t.contacts,function(t){a.GetMsgs({userid:t},function(t){angular.equals(t.data,[])||angular.forEach(t.data,function(t){t.receiver==c.userId&&0==t.read&&(c.newmsg=parseInt(c.newmsg)+1)})})})}))}),t.openChatWindow=function(e,a){i()?n.show({controller:["$scope","userService","requestService","$cookies","$mdDialog",function(t,e,n,o,s){function c(e){t.curContact=e,n.GetMsgs({userid:t.contacts[t.curContact]},function(e){t.messages=e.data,l()})}function i(){n.GetContact(function(e){0==e.contacts.length?(t.contacts=[],""!==a&&t.contacts.push(a),t.curContact=0):(t.contacts=e.contacts,""!==a?(-1!==t.contacts.indexOf(a)&&t.contacts.splice(t.contacts.indexOf(a),1),t.contacts.push(a),t.contacts=t.contacts.reverse(),t.curContact=0):(t.contacts=t.contacts.reverse(),t.curContact=0)),0!==t.contacts.length&&n.GetMsgs({userid:t.contacts[0]},function(e){t.messages=e.data,l()}),angular.forEach(t.contacts,function(e){t.contactDetails.push({})}),angular.forEach(t.contacts,function(e){n.GetUser({id:e},function(n){t.contactDetails[t.contacts.indexOf(e)]=n.data})})})}function r(){e.sendmessage({id:t.contacts[t.curContact],content:t.contents}).then(function(e){e.result?n.GetMsgs({userid:t.contacts[t.curContact]},function(e){t.messages=e.data,t.contents=""}):alert("err")})}function l(){angular.forEach(t.messages,function(t){(0==t.read&&t.sender!==o.userId||0==t.read&&t.sender==t.receiver)&&e.updateMessages({id:t._id}).then(function(e){e.result&&(t.read=!0,o.newmsg=parseInt(o.newmsg)-1)})})}t.hide=function(){s.hide()},t.initMsgs=i,t.updateMsgs=l,t.setCurContact=c,t.sendMessage=r,t.contactDetails=[],t.messages=[],t.contents="",i()}],templateUrl:"/app/view/partials/_chat_window_temp.html",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0}):o.alert("请先登录").then(function(){t.showLogin()})},C()}]),hereseasApp.controller("TopBarController",["$scope","$stateParams","requestService",function(t,e,n){n.GetSchool({id:e.schoolId},function(e){e.result&&(t.avatar=e.data.avatar)})}]);